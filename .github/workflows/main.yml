name: Production CI/CD Pipeline

# ------------------------------------------------------------------
# Trigger: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Push Code ‡πÄ‡∏Ç‡πâ‡∏≤ Branch 'main'
# ------------------------------------------------------------------
on:
    push:
        branches: ["main"]

jobs:
    # ==================================================================
    # JOB 1: CI - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡∏ô GitHub Server)
    # ==================================================================
    ci-check:
        name: üîç Build & Quality Check
        runs-on: ubuntu-latest

        steps:
            - name: üì• Checkout Code
              uses: actions/checkout@v4

            - name: üü¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22" # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô Node ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
                  cache: "npm" # ‡πÄ‡∏õ‡∏¥‡∏î Cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô

            - name: üì¶ Install Dependencies
              # ‡πÉ‡∏ä‡πâ npm ci ‡πÅ‡∏ó‡∏ô npm install ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
              run: npm ci

            - name: üîé Run Lint Check
              # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Code ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ñ‡∏π‡∏Å Format ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
              run: npm run lint

            - name: üèóÔ∏è Test Build
              # ‡∏•‡∏≠‡∏á Build ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏´‡∏° (‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÑ‡∏°‡πà‡πÑ‡∏õ Deploy ‡∏ï‡πà‡∏≠)
              run: npm run build

    # ==================================================================
    # JOB 2: CD - ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Server (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡∏ô VPS ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏ú‡πà‡∏≤‡∏ô SSH)
    # ==================================================================
    cd-deploy:
        name: üöÄ Deploy to VPS
        needs: ci-check # ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÉ‡∏´‡πâ CI ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ó‡∏≥ Deploy
        runs-on: ubuntu-latest

        steps:
            - name: üîå Remote SSH & Execute Commands
              uses: appleboy/ssh-action@v1.0.3
              with:
                  # ‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô Settings > Secrets ‡∏Ç‡∏≠‡∏á Repository
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USERNAME }}
                  password: ${{ secrets.VPS_PASSWORD }}
                  port: 22

                  # Script Timeout (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Build ‡∏ô‡∏≤‡∏ô) - ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (30 ‡∏ô‡∏≤‡∏ó‡∏µ)
                  timeout: 1800

                  # --------------------------------------------------------
                  # ‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏ö‡∏ô Server (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Path ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á)
                  # --------------------------------------------------------
                  script: |
                      # 1. ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á Folder ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
                      # [EDIT HERE] ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö path ‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô server
                      cd /var/www/grantpdf

                      # 2. Reset Local Changes
                      # ‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ô Server ‡∏ó‡∏¥‡πâ‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Conflict ‡∏ï‡∏≠‡∏ô Pull
                      git reset --hard HEAD

                      # 3. Pull Code ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å GitHub
                      git pull origin main

                      # 4. Install Dependencies (Clean Install)
                      # ‡∏•‡∏ö node_modules ‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏° package-lock.json
                      npm ci

                      # 5. Prisma Generate
                      # ‡∏™‡∏£‡πâ‡∏≤‡∏á Prisma Client ‡πÉ‡∏´‡∏°‡πà (‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏´‡∏•‡∏±‡∏á npm ci ‡πÄ‡∏™‡∏°‡∏≠)
                      npx prisma generate

                      # 6. Prisma Migrate Deploy
                      # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Database (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå migration ‡πÉ‡∏´‡∏°‡πà)
                      npx prisma migrate deploy

                      # 7. Build Next.js Production
                      # ‡∏™‡∏£‡πâ‡∏≤‡∏á folder .next ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                      npm run build

                      # 8. Reload PM2 (Zero Downtime)
                      # [EDIT HERE] ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠ 'my-app-name' ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô pm2 list
                      pm2 reload grantpdf --update-env

                      # ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                      echo "üöÄ Deployment Completed Successfully!"
